<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Controle de Estoque</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
:root{
  --roxo:#641b6b;
  --roxo-escuro:#4a0f52;
  --verde:#45b043;
  --cinza:#f6f7f9;
  --borda:#e6e7ea;
  --texto:#212529;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--cinza);
  color:var(--texto);
  font-family: Arial, Helvetica, sans-serif;
  -webkit-tap-highlight-color: transparent;
}
header{
  background: linear-gradient(180deg, var(--roxo), var(--roxo-escuro));
  color:#fff;
  padding:12px 10px 8px;
  text-align:left; /* alinhado à esquerda */
}
header .brand{
  display:flex; align-items:center; justify-content:flex-start; gap:8px; /* logo à esquerda, texto ao lado */
}
header img.logo{
  height:60px; width:auto; object-fit:contain;
  /* removidos para ficar sem fundo branco */
  background:transparent;
  padding:0;
  border-radius:0;
}
header h1{
  margin:0;
  font-size:24px;
  font-weight:700;
  letter-spacing:.3px;
}
#toolbar{
  background:#fff;
  padding:8px;
  display:flex; flex-wrap:wrap; gap:6px; justify-content:center;
  border-bottom:1px solid var(--borda);
  position:sticky; top:0; z-index:5;
}
#toolbar button, #toolbar select{
  padding:6px 10px;
  font-size:14px;
  border-radius:10px;
  border:1px solid var(--borda);
  background:#fff;
}
#toolbar button.primary{
  background:var(--verde);
  color:#fff; border-color:var(--verde);
  font-weight:600;
}
#editor{
  background:#fff;
  margin:10px;
  border-radius:14px;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
  border:1px solid var(--borda);
  overflow:hidden;
  transition: background 0.3s;
}
.linha{
  display:flex; align-items:flex-start; gap:6px;
  padding:6px 10px;
  border-bottom:1px dashed #ececf0;
}
.linha:last-child{ border-bottom:none; }
.linha input[type="checkbox"]{
  width:18px; height:18px; margin-top:6px; flex:0 0 auto;
  accent-color: var(--verde);
}
.linha[data-tipo="texto"] input[type="checkbox"]{ display:none; }
.bloco{
  flex:1 1 auto;
  min-height:24px;
  outline:none;
  border:none;
  background:transparent;
  font-size:16px;
  line-height:1.35;
  padding:2px 2px;
  word-break:break-word;
}
.linha.focused{ background:#fbfbfe; }
.bloco:empty:before{
  content: attr(data-placeholder);
  color:#9aa0a6;
}
.apagar{ display:none; }

/* >>> Estilos do "Esgotado" (fundo pincelado vermelho clarinho + contorno) <<< */
.esgotado-wrapper{
  display:inline-flex; align-items:center; gap:6px;
  margin-left:8px; margin-top:4px; /* harmoniza com align-items:flex-start */
}
.esgotado-wrapper input[type="checkbox"]{
  width:18px; height:18px; flex:0 0 auto; accent-color: var(--verde);
}
.esgotado-label{
  display:none; /* aparece só quando marcado */
  position:relative;
  padding:2px 8px;
  border-radius:8px;
  background:#ffcccc; /* vermelho clarinho */
  color:#ffffff;
  font-size:13px;
  font-weight:700;
  line-height:1;
  user-select:none;
  overflow:hidden;
  -webkit-text-stroke:0.6px black; /* contorno preto fino */
}
.esgotado-label::before{
  content:"";
  position:absolute; inset:0;
  background:repeating-linear-gradient(
    -45deg,
    rgba(255,120,120,0.45) 0 6px,
    transparent 6px 12px
  );
  pointer-events:none;
  mix-blend-mode:multiply;
}

@media (max-width:480px){
  header h1{ font-size:24px; }
  #toolbar select{ min-width:110px; }
  #toolbar button, #toolbar select{ font-size:14px; padding:6px 8px; }
}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onChildAdded, onChildChanged, onChildRemoved, set, update, remove, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD1LRhrVBA5T2qfunpg8bTXlA5Z58-RL6M",
  authDomain: "lista-de-itens-em-falta.firebaseapp.com",
  databaseURL: "https://lista-de-itens-em-falta-default-rtdb.firebaseio.com",
  projectId: "lista-de-itens-em-falta",
  storageBucket: "lista-de-itens-em-falta.appspot.com",
  messagingSenderId: "178769313308",
  appId: "1:178769313308:web:cdb4cdc520f8eeb23729d9",
  measurementId: "G-MTRHXEFMP8"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const sala = location.hash.replace("#","") || "default";
const blocosRef = ref(db, `salas/${sala}/blocos`);
const editor = document.getElementById('editor');
const fonteSel = document.getElementById('fonte');
const tamSel   = document.getElementById('tamanho');
let focoId = null;
const novaChave = () => push(blocosRef).key;

/* === util: cria/adiciona o UI do "Esgotado" e liga ao Firebase === */
function ensureEsgotadoUI(linha, id, esgotadoEstado){
  let wrap = linha.querySelector('.esgotado-wrapper');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.className = 'esgotado-wrapper';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'esgotado-cb';

    const label = document.createElement('span');
    label.className = 'esgotado-label';
    label.textContent = 'Esgotado';

    // Quando o checkbox "Esgotado" muda:
    cb.addEventListener('change', ()=>{
      const mainCheckbox = linha.querySelector('input[type="checkbox"]:not(.esgotado-cb)');
      const checked = cb.checked;

      // Sincroniza o checkbox principal com o estado do esgotado (marca/desmarca)
      if(mainCheckbox){
        mainCheckbox.checked = !!checked;
      }

      // Salva ambos os estados no Firebase (garante não sobrescrever outros campos)
      update(ref(db, `salas/${sala}/blocos/${id}`), { marcado: !!checked, esgotado: !!checked });

      // Visual: esconder o checkbox de esgotado quando estiver marcado, mostrar só a palavra
      cb.style.display = checked ? 'none' : '';
      label.style.display = checked ? 'inline-block' : 'none';
    });

    // Ao clicar na palavra "Esgotado" (quando visível), desmarca ambos
    label.addEventListener('click', ()=>{
      const cbEl = wrap.querySelector('.esgotado-cb');
      const mainCheckbox = linha.querySelector('input[type="checkbox"]:not(.esgotado-cb)');

      // Desmarca visualmente e no DB
      if(cbEl) cbEl.checked = false;
      if(mainCheckbox) mainCheckbox.checked = false;

      update(ref(db, `salas/${sala}/blocos/${id}`), { marcado: false, esgotado: false });

      // Volta a mostrar o checkbox de esgotado e esconder a palavra
      if(cbEl) cbEl.style.display = '';
      label.style.display = 'none';
    });

    wrap.appendChild(cb);
    wrap.appendChild(label);
    linha.appendChild(wrap);
  }

  // aplica estado atual
  const cb = wrap.querySelector('.esgotado-cb');
  const label = wrap.querySelector('.esgotado-label');
  cb.checked = !!esgotadoEstado;
  cb.style.display = cb.checked ? 'none' : '';
  label.style.display = cb.checked ? 'inline-block' : 'none';

  // visibilidade conforme tipo
  if(linha.dataset.tipo === 'texto'){
    wrap.style.display = 'none';
  } else {
    wrap.style.display = 'inline-flex';
  }
}

function criarBlocoDOM(id, data){
  const linha = document.createElement('div');
  linha.className = 'linha';
  linha.dataset.id = id;
  linha.dataset.tipo = data.tipo || 'texto';

  const check = document.createElement('input');
  check.type = 'checkbox';
  check.checked = !!data.marcado;

  const bloco = document.createElement('div');
  bloco.className = 'bloco';
  bloco.contentEditable = "true";
  bloco.dataset.placeholder = "Toque e escreva...";
  bloco.innerText = (data.conteudo || "");
  bloco.style.fontFamily = data.fonte || 'Arial';
  bloco.style.fontSize   = data.tamanho || '18px';

  bloco.addEventListener('focus', () => {
    focoId = id;
    document.querySelectorAll('.linha').forEach(l=>l.classList.remove('focused'));
    linha.classList.add('focused');
    fonteSel.value = (data.fonte || 'Arial');
    tamSel.value   = (data.tamanho || '18px');
  });

  bloco.addEventListener('input', () => {
    update(ref(db, `salas/${sala}/blocos/${id}`), { conteudo: bloco.innerText });
    ensureLinhaVaziaNoFim();
  });

  bloco.addEventListener('keydown', (e) => {
    if(e.key === 'Backspace'){
      const sel = window.getSelection();
      if(sel.rangeCount > 0){
        const range = sel.getRangeAt(0);
        if(range.startOffset === 0 && bloco.innerText.trim() === ''){
          e.preventDefault();
          remove(ref(db, `salas/${sala}/blocos/${id}`));
          const linhas = [...editor.querySelectorAll('.linha')];
          const idx = linhas.findIndex(l => l.dataset.id === id);
          if(idx > 0) linhas[idx-1].querySelector('.bloco').focus();
        }
      }
    }
  });

  check.addEventListener('change', () => {
    update(ref(db, `salas/${sala}/blocos/${id}`), { marcado: check.checked });
  });

  linha.appendChild(check);
  linha.appendChild(bloco);

  /* >>> acrescenta o UI do "esgotado" para linhas com checkbox <<< */
  if(linha.dataset.tipo !== 'texto'){
    ensureEsgotadoUI(linha, id, data.esgotado);
  }

  return linha;
}

function renderAdd(id, data){ editor.appendChild(criarBlocoDOM(id, data)); }
function renderChange(id, data){
  const node = editor.querySelector(`.linha[data-id="${id}"]`);
  if(!node) return renderAdd(id, data);
  node.dataset.tipo = data.tipo || 'texto';
  const check = node.querySelector('input[type="checkbox"]:not(.esgotado-cb)'); // pega o 1º: o principal
  const bloco = node.querySelector('.bloco');
  check.style.display = (node.dataset.tipo === 'texto') ? 'none' : '';
  if(document.activeElement !== bloco) bloco.innerText = data.conteudo || '';
  bloco.style.fontFamily = data.fonte || 'Arial';
  bloco.style.fontSize   = data.tamanho || '18px';
  check.checked = !!data.marcado;

  // garante e sincroniza o "esgotado"
  ensureEsgotadoUI(node, id, data.esgotado);
}
function renderRemove(id){
  const node = editor.querySelector(`.linha[data-id="${id}"]`);
  if(node) node.remove();
  ensureLinhaVaziaNoFim();
}

function ensureLinhaVaziaNoFim(){
  const linhas = [...editor.querySelectorAll('.linha')];
  const ultima = linhas[linhas.length-1];
  if(!ultima){ criarLinhaBD(); return; }
  const blocoUlt = ultima.querySelector('.bloco');
  if(blocoUlt && blocoUlt.innerText.trim() !== '') criarLinhaBD();
}

function criarLinhaBD(conteudo='', tipo='texto'){
  const id = novaChave();
  const data = { tipo, conteudo, marcado:false, esgotado:false, fonte:'Arial', tamanho:'18px', ordem: Date.now() };
  set(ref(db, `salas/${sala}/blocos/${id}`), data);
  return id;
}

editor.addEventListener('pointerdown', (e)=>{
  if(e.target.id === 'editor'){
    ensureLinhaVaziaNoFim();
    const ultima = editor.querySelector('.linha:last-child .bloco');
    if(ultima) ultima.focus();
  }
});

// COLAGEM DE MÚLTIPLAS LINHAS COM CHECKBOX
editor.addEventListener('paste', (e)=>{
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text');
  const linhas = text.split(/\r?\n/).filter(l=>l.trim()!=='');
  linhas.forEach(l=> criarLinhaBD(l, 'caixa'));
});

// Toolbar
window.aplicarFonte = function(){ if(!focoId) return; update(ref(db, `salas/${sala}/blocos/${focoId}`), { fonte: fonteSel.value }); }
window.aplicarTamanho = function(){ if(!focoId) return; update(ref(db, `salas/${sala}/blocos/${focoId}`), { tamanho: tamSel.value }); }
window.toggleCheckbox = function(){
  if(!focoId) return;
  const node = editor.querySelector(`.linha[data-id="${focoId}"]`);
  if(!node) return;
  const novoTipo = (node.dataset.tipo === 'texto') ? 'caixa' : 'texto';
  update(ref(db, `salas/${sala}/blocos/${focoId}`), { tipo: novoTipo });
}

// Botão mudar fundo
let fundoAtual = 0;
const coresFundo = ['#ffffff', '#f6f7f9', '#fffbf0', '#e0f7fa', '#fde0e0'];
window.mudarFundo = function(){
  fundoAtual = (fundoAtual + 1) % coresFundo.length;
  document.getElementById('editor').style.background = coresFundo[fundoAtual];
}

// Firebase listeners
onChildAdded(blocosRef, (snap)=> renderAdd(snap.key, snap.val()));
onChildChanged(blocosRef, (snap)=> renderChange(snap.key, snap.val()));
onChildRemoved(blocosRef, (snap)=> renderRemove(snap.key));
onValue(blocosRef, (snap)=>{
  if(!snap.exists()) criarLinhaBD();
  requestAnimationFrame(()=>{
    editor.querySelectorAll('.linha').forEach(l=>{
      const tipo = l.dataset.tipo;
      const chk = l.querySelector('input[type="checkbox"]:not(.esgotado-cb)'); // principal
      if(!chk) return;
      chk.style.display = (tipo === 'texto') ? 'none' : '';
      const wrap = l.querySelector('.esgotado-wrapper');
      if(wrap) wrap.style.display = (tipo === 'texto') ? 'none' : 'inline-flex';
    });
  });
});
</script>
</head>
<body>
<header>
  <div class="brand">
    <img src="acailogo.png" alt="Açaí Delivery Pádua" class="logo" />
    <h1>Controle de Estoque</h1>
  </div>
</header>
<div id="toolbar">
  <button id="toggleCheck" class="primary" onclick="toggleCheckbox()">Checkbox</button>
  <select id="fonte" onchange="aplicarFonte()">
    <option value="Arial">Arial</option>
    <option value="Verdana">Verdana</option>
    <option value="Courier New">Courier</option>
    <option value="Times New Roman">Times</option>
  </select>
  <select id="tamanho" onchange="aplicarTamanho()">
    <option value="14px">14px</option>
    <option value="16px">16px</option>
    <option value="18px" selected>18px</option>
    <option value="22px">22px</option>
    <option value="24px">24px</option>
    <option value="28px">28px</option>
    <option value="32px">32px</option>
  </select>
  <button onclick="mudarFundo()">Mudar Fundo</button>
</div>
<div id="editor" aria-label="Área de edição – toque para digitar"></div>
</body>
</html>
